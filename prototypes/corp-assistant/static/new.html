<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
        <p>–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</p>
      </div>

      <div class="form-container">
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
        <div class="step-indicator">
          <div class="step-line"></div>
          <div class="step-line-fill" id="stepLineFill"></div>
          <div class="step active" id="step1">1</div>
          <div class="step" id="step2">2</div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div class="error-message" id="errorMessage"></div>

        <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ -->
        <div class="step-content active" id="stepContent1">
          <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" class="file-input" multiple />
            <div class="upload-icon">üì§</div>
            <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
            <div class="upload-subtext">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</div>
            <div class="upload-subtext">
              –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOC, XLS, JPG, PNG, ZIP (–¥–æ 50 –ú–ë)
            </div>
          </div>

          <div class="file-list" id="fileList">
            <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
          </div>

          <div class="button-group">
            <button
              class="btn btn-primary"
              id="uploadBtn"
              onclick="uploadFiles()"
              disabled
            >
              –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã
            </button>
          </div>
        </div>

        <!-- –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>

          <div class="success-message" id="successMessage">
            <div class="success-icon">‚úì</div>
            <h2 style="margin-bottom: 16px; color: #333">
              ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
            </h2>
            <p style="color: #666; margin-bottom: 24px">
              –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
            </p>
            <button class="btn btn-secondary" onclick="resetForm()">
              –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.ready();

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      let selectedFiles = [];
      const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 –ú–ë
      const SUPPORTED_EXTENSIONS = [
        "pdf",
        "doc",
        "docx",
        "xls",
        "xlsx",
        "jpg",
        "jpeg",
        "png",
        "zip",
      ];
      // –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞
      const API_ENDPOINT =
        "https://9a56d20f142c.ngrok-free.app/api/v1/documents/upload";

      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const stepLineFill = document.getElementById("stepLineFill");
      const stepContent1 = document.getElementById("stepContent1");
      const progressContainer = document.getElementById("progressContainer");
      const fileInput = document.getElementById("fileInput");
      const uploadArea = document.getElementById("uploadArea");
      const fileList = document.getElementById("fileList");
      const uploadBtn = document.getElementById("uploadBtn");
      const errorMessage = document.getElementById("errorMessage");
      const progressFill = document.getElementById("progressFill");
      const successMessage = document.getElementById("successMessage");

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      function init() {
        setupEventListeners();
        resetForm();
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
      function setupEventListeners() {
        // –ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        uploadArea.addEventListener("click", () => fileInput.click());

        // –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ input
        fileInput.addEventListener("change", handleFileSelect);

        // Drag and Drop
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("drag-over");
        });

        uploadArea.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–ª–∏ –∏–∑ –æ–±–ª–∞—Å—Ç–∏
          if (!uploadArea.contains(e.relatedTarget)) {
            uploadArea.classList.remove("drag-over");
          }
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("drag-over");
          if (e.dataTransfer.files.length) {
            handleFiles(Array.from(e.dataTransfer.files));
          }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
        errorMessage.addEventListener("click", () => {
          errorMessage.style.display = "none";
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ input
      function handleFileSelect(e) {
        handleFiles(Array.from(e.target.files));
        fileInput.value = ""; // –°–±—Ä–æ—Å input
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
      function handleFiles(files) {
        errorMessage.style.display = "none";
        errorMessage.textContent = "";

        const newFiles = Array.from(files);
        const validFiles = [];
        const errors = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
        newFiles.forEach((file) => {
          const fileExtension = file.name.split(".").pop().toLowerCase();

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
          if (!SUPPORTED_EXTENSIONS.includes(fileExtension)) {
            errors.push(`"${file.name}" - –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç`);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
          if (file.size > MAX_FILE_SIZE) {
            errors.push(`"${file.name}" - –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50 –ú–ë`);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
          if (
            selectedFiles.some(
              (f) => f.name === file.name && f.size === file.size,
            )
          ) {
            errors.push(`"${file.name}" - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω`);
            return;
          }

          validFiles.push(file);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (errors.length > 0) {
          showError(`–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã:<br>${errors.join("<br>")}`);
        }

        if (validFiles.length === 0) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        selectedFiles = [...selectedFiles, ...validFiles];
        renderFileList();
        updateUploadButton();
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
      function renderFileList() {
        fileList.innerHTML = "";

        if (selectedFiles.length === 0) {
          fileList.style.display = "none";
          return;
        }

        fileList.style.display = "block";

        selectedFiles.forEach((file, index) => {
          const fileElement = document.createElement("div");
          fileElement.className = "file-item";

          const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

          fileElement.innerHTML = `
          <div class="file-info">
            <div class="file-name">${escapeHtml(file.name)}</div>
            <div class="file-size">${sizeMB} –ú–ë</div>
          </div>
          <button class="remove-btn" onclick="removeFile(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
        `;

          fileList.appendChild(fileElement);
        });
      }

      // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
      function removeFile(index) {
        selectedFiles.splice(index, 1);
        renderFileList();
        updateUploadButton();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
      function updateUploadButton() {
        uploadBtn.disabled = selectedFiles.length === 0;
        uploadBtn.textContent =
          selectedFiles.length > 0
            ? `–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã (${selectedFiles.length})`
            : "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
      function showError(message) {
        errorMessage.innerHTML = message;
        errorMessage.style.display = "block";

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          if (errorMessage.style.display === "block") {
            errorMessage.style.display = "none";
          }
        }, 7000);
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      async function uploadFiles() {
        if (selectedFiles.length === 0) return;

        // –ü–æ–ª—É—á–∞–µ–º Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const telegramUserId =
          tg.initDataUnsafe?.user?.id ||
          tg.initDataUnsafe?.user_id ||
          tg.initData?.user?.id;

        if (!telegramUserId) {
          showError(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.",
          );
          return;
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ç–æ—Ä–æ–º—É —à–∞–≥—É
        step1.classList.remove("active");
        step2.classList.add("active");
        stepLineFill.style.width = "100%";
        stepContent1.classList.remove("active");
        progressContainer.classList.add("active");

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        progressFill.style.width = "30%";
        successMessage.style.display = "none";

        try {
          // –°–æ–∑–¥–∞–µ–º FormData
          const formData = new FormData();
          selectedFiles.forEach((file) => {
            formData.append("files", file);
          });

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
              "X-User-ID": telegramUserId.toString(),
              // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å boundary
            },
            body: formData,
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          progressFill.style.width = "70%";

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
          if (response.status === 201) {
            // –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            progressFill.style.width = "100%";
            setTimeout(() => {
              successMessage.style.display = "block";
            }, 500);
          } else if (response.status === 403) {
            throw new Error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
          } else if (response.status === 400) {
            throw new Error("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-User-ID");
          } else {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞
            let errorText = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`;
            try {
              const errorData = await response.json();
              if (errorData.detail) {
                errorText = errorData.detail;
              }
            } catch (e) {
              // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ç–µ–∫—Å—Ç
            }
            throw new Error(errorText);
          }
        } catch (error) {
          console.error("Upload error:", error);

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          step1.classList.add("active");
          step2.classList.remove("active");
          stepLineFill.style.width = "50%";
          stepContent1.classList.add("active");
          progressContainer.classList.remove("active");

          showError(
            error.message ||
              "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",
          );
        }
      }

      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      function resetForm() {
        selectedFiles = [];
        fileInput.value = "";
        fileList.innerHTML = "";
        fileList.style.display = "none";
        uploadBtn.disabled = true;
        uploadBtn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";

        // –°–±—Ä–æ—Å —à–∞–≥–æ–≤
        step1.classList.add("active");
        step2.classList.remove("active");
        stepLineFill.style.width = "50%";
        stepContent1.classList.add("active");
        progressContainer.classList.remove("active");
        successMessage.style.display = "none";
        progressFill.style.width = "0%";

        errorMessage.style.display = "none";
        errorMessage.textContent = "";
      }

      // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", init);

      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
      window.uploadFiles = uploadFiles;
      window.resetForm = resetForm;
      window.removeFile = removeFile;
    </script>
  </body>
</html>
